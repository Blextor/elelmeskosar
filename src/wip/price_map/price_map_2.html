<!doctype html>
<html lang="hu">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Üzletek térképe – zöld→vörös skála, fix marker méret</title>

  <!-- Leaflet CSS/JS (CDN) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <style>
    :root {
      --card-bg: #ffffff;
      --card-br: 14px;
      --card-bd: #e5e7eb;
      --card-shadow: 0 8px 24px rgba(0,0,0,.08);
      --text: #111827;
      --muted: #6b7280;
    }
    html, body { height: 100%; margin: 0; background: #f8fafc; color: var(--text); font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    .page {
      padding: 24px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-bd);
      border-radius: var(--card-br);
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .card-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--card-bd);
      background: #fcfcfd;
    }
    .card-title {
      margin: 0 0 4px 0;
      font-weight: 600;
      font-size: 16px;
    }
    .card-subtitle {
      margin: 0;
      color: var(--muted);
      font-size: 13px;
    }

    .card-body {
      position: relative;
    }

    #map { height: 70vh; min-height: 420px; width: 100%; }

    /* Tooltip olvasható */
    .leaflet-tooltip {
      background: white;
      border: 1px solid #ddd;
      box-shadow: 0 2px 8px rgba(0,0,0,.15);
      padding: .35rem .5rem;
      font-size: 13px;
    }

    /* Színskála – vízszintes folytonos sáv */
    .colorbar-wrap {
    position: absolute;
    bottom: 14px;
    left: 12px;
    right: auto;
    background: white;
    border: 1px solid #ddd;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,.08);
    padding: 10px 12px;
    min-width: 240px;

    /* ÚJ: legyen a Leaflet pane-ek fölött, de a tooltip/popup alatt */
    z-index: 640;           /* tooltip ~650, popup ~700 */
    pointer-events: none;   /* ne zavarja a térkép mozgatását/zoomot */
    }
    .colorbar-labels span { pointer-events: auto; } /* ha mégis kattintható/selektálható szöveg kell */
    .colorbar-title {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .colorbar {
      height: 14px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,.15);
      background: linear-gradient(90deg, #22c55e 0%, #ef4444 100%);
    }
    .colorbar-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 6px;
    }
    .colorbar-labels span strong { font-weight: 600; }
  </style>
</head>
<body>
  <div class="page">
    <div class="card" aria-label="Üzletek térképe kártya">
      <div class="card-header">
        <h1 class="card-title">Üzletek térképe</h1>
        <p class="card-subtitle">Vidd a kurzort egy pontra – megjelenik az üzlet neve és a hozzárendelt érték. A pöttyök mérete fix, a szín a zöld→vörös skálán az értéktől függ (nagyobb = vörösebb).</p>
      </div>

      <div class="card-body">
        <div id="map" role="region" aria-label="Üzletek térképe"></div>

        <!-- Színkód skála -->
        <div class="colorbar-wrap" id="legend">
          <div class="colorbar-title">Érték szerinti színkód</div>
          <div class="colorbar"></div>
          <div class="colorbar-labels">
            <span id="minLabel">Min: <strong>—</strong></span>
            <span id="midLabel">Közép: <strong>—</strong></span>
            <span id="maxLabel">Max: <strong>—</strong></span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 1) ADATAID
    const storeData = [
      { name: "Sarki ABC",           value: 12, lat: 47.4979, lng: 19.0402 }, // Budapest
      { name: "Helyi Piac",          value: 35, lat: 46.2530, lng: 20.1414 }, // Szeged
      { name: "FrissFood Szolnok",   value: 22, lat: 47.1747, lng: 20.1943 },
      { name: "BioBolt Győr",        value: 48, lat: 47.6875, lng: 17.6504 },
      { name: "Gazda Kft. Debrecen", value: 8,  lat: 47.5316, lng: 21.6273 }
    ];

    // 2) PARAMÉTEREK
    const VALUE_MIN = Math.min(...storeData.map(d => d.value));
    const VALUE_MAX = Math.max(...storeData.map(d => d.value));
    const FIXED_RADIUS = 10; // px – pöttyök fix mérete

    // 3) LEAFLET TÉRKÉP
    const map = L.map('map', { scrollWheelZoom: true }).setView([47.1625, 19.5033], 7);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> közreműködők'
    }).addTo(map);

    // 4) ZÖLD → VÖRÖS SZÍNSKÁLA (alacsony = zöld, magas = vörös)
    function lerp(a, b, t) { return a + (b - a) * t; }
    function clamp(x, lo, hi) { return Math.max(lo, Math.min(hi, x)); }
    function colorForValue(v) {
      const t = VALUE_MAX === VALUE_MIN ? 0.5 : (v - VALUE_MIN) / (VALUE_MAX - VALUE_MIN);
      const c1 = { r: 34,  g: 197, b: 94  }; // #22c55e zöld
      const c2 = { r: 239, g: 68,  b: 68  }; // #ef4444 vörös
      const r = Math.round(lerp(c1.r, c2.r, clamp(t, 0, 1)));
      const g = Math.round(lerp(c1.g, c2.g, clamp(t, 0, 1)));
      const b = Math.round(lerp(c1.b, c2.b, clamp(t, 0, 1)));
      return `rgb(${r}, ${g}, ${b})`;
    }

    // 5) MARKEREK (fix méret, szín az értéktől)
    const layerGroup = L.layerGroup().addTo(map);

    storeData.forEach(d => {
      const marker = L.circleMarker([d.lat, d.lng], {
        radius: FIXED_RADIUS,
        color: '#00000055',
        weight: 1,
        fillColor: colorForValue(d.value),
        fillOpacity: 0.9
      }).addTo(layerGroup);

      // Tooltip hoverre
      marker.bindTooltip(
        `<strong>${escapeHtml(d.name)}</strong><br/>Érték: <strong>${d.value}</strong>`,
        { direction: 'top', offset: [0, -2], sticky: true }
      );

      // Hover-kiemelés (méret nem változik)
      marker.on('mouseover', () => {
        marker.setStyle({ weight: 2, fillOpacity: 1.0 });
      });
      marker.on('mouseout', () => {
        marker.setStyle({ weight: 1, fillOpacity: 0.9 });
      });
    });

    // 6) SZÍNSKÁLA FELIRATOK (min / közép / max)
    const minEl = document.getElementById('minLabel').querySelector('strong');
    const midEl = document.getElementById('midLabel').querySelector('strong');
    const maxEl = document.getElementById('maxLabel').querySelector('strong');
    const midVal = VALUE_MIN === VALUE_MAX ? VALUE_MIN : Math.round((VALUE_MIN + VALUE_MAX) / 2);

    minEl.textContent = VALUE_MIN;
    midEl.textContent = midVal;
    maxEl.textContent = VALUE_MAX;

    // 7) Automatikus ránagyítás
    if (storeData.length > 0) {
      const bounds = L.latLngBounds(storeData.map(d => [d.lat, d.lng]));
      map.fitBounds(bounds.pad(0.1));
    }

    // 8) HTML-escape
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
  </script>
</body>
</html>
